<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dzintaru Dziesmas — Character Creator</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=IM+Fell+English:ital@0;1&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,400&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{background:#0e0b06;color:#d4b896;font-family:'Crimson Pro',serif;font-size:17px;line-height:1.6;min-height:100vh;overflow-x:hidden}
:root{
  --bg:#0e0b06;--surface:#16100a;--card:#1c1409;--card2:#221a0c;
  --border:#3a2a0e;--border2:#4d3a15;
  --amber:#c8820a;--gold:#e8b84b;--gold2:#f5d070;--gold-dim:#9e7228;
  --text:#d4b896;--muted:#7a6040;--muted2:#a08050;
  --red:#c0392b;--green:#2e7d4f;
}
#app{position:relative;max-width:940px;margin:0 auto;padding:40px 24px 100px}

/* HEADER */
.site-header{text-align:center;padding:36px 0 28px;position:relative}
.site-header::after{content:'';display:block;width:100%;height:1px;background:linear-gradient(to right,transparent,var(--gold-dim),var(--amber),var(--gold-dim),transparent);margin-top:24px}
.eyebrow{font-family:'Cinzel',serif;font-size:.65rem;letter-spacing:.35em;text-transform:uppercase;color:var(--muted2);margin-bottom:10px}
.main-title{font-family:'Cinzel',serif;font-size:clamp(1.8rem,5vw,3rem);font-weight:900;color:var(--gold);letter-spacing:.06em;text-shadow:0 0 60px rgba(200,130,10,.35),0 2px 4px rgba(0,0,0,.8)}
.main-sub{font-family:'IM Fell English',serif;font-style:italic;color:var(--muted2);font-size:1rem;margin-top:8px}

/* STEPS NAV */
.steps-nav{display:flex;align-items:center;justify-content:center;margin:32px 0 36px;flex-wrap:wrap;row-gap:10px}
.step-node{display:flex;flex-direction:column;align-items:center;gap:5px}
.step-node.clickable{cursor:pointer}
.step-circle{width:34px;height:34px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-family:'Cinzel',serif;font-size:.7rem;font-weight:700;color:var(--muted);background:var(--surface);transition:all .2s}
.step-node.done .step-circle{border-color:var(--amber);color:var(--amber);background:rgba(200,130,10,.08)}
.step-node.active .step-circle{border-color:var(--gold);color:var(--gold);background:rgba(232,184,75,.12);box-shadow:0 0 14px rgba(232,184,75,.2)}
.step-node.clickable:hover .step-circle{border-color:var(--amber)}
.step-lbl{font-family:'Cinzel',serif;font-size:.52rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);white-space:nowrap}
.step-node.active .step-lbl{color:var(--gold)}
.step-node.done .step-lbl{color:var(--amber)}
.step-line{width:28px;height:2px;background:var(--border);margin-bottom:20px;flex-shrink:0;transition:background .3s}
.step-line.done{background:var(--amber)}

/* CARD */
.card{background:var(--card);border:1px solid var(--border);border-radius:3px;padding:28px;margin-bottom:20px;position:relative;overflow:hidden}
.card::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(200,130,10,.03) 0%,transparent 50%);pointer-events:none}
.card-title{font-family:'Cinzel',serif;font-size:1.1rem;font-weight:700;color:var(--gold);letter-spacing:.05em;margin-bottom:4px}
.card-sub{font-family:'IM Fell English',serif;font-style:italic;color:var(--muted2);font-size:.95rem;margin-bottom:22px}
.sep{border:none;border-top:1px solid var(--border);margin:20px 0}

/* FORM */
.field{margin-bottom:18px}
.lbl{display:block;font-family:'Cinzel',serif;font-size:.62rem;letter-spacing:.2em;text-transform:uppercase;color:var(--gold-dim);margin-bottom:6px}
input[type=text],input[type=number],textarea,select{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:2px;color:var(--text);font-family:'Crimson Pro',serif;font-size:1rem;padding:9px 13px;outline:none;transition:border-color .15s}
input[type=text]:focus,input[type=number]:focus,textarea:focus,select:focus{border-color:var(--amber)}
textarea{resize:vertical;min-height:75px}
.hint{font-style:italic;color:var(--muted);font-size:.85rem;margin-top:4px}

/* AGE */
.age-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.age-card{background:var(--surface);border:2px solid var(--border);border-radius:3px;padding:22px 14px;cursor:pointer;transition:all .2s;text-align:center}
.age-card:hover{border-color:var(--amber)}
.age-card.sel{border-color:var(--gold);background:rgba(232,184,75,.06)}
.age-name{font-family:'Cinzel',serif;font-size:1.25rem;font-weight:700;color:var(--gold);margin-bottom:14px}
.age-stat{font-size:.88rem;color:var(--muted2);margin:4px 0}
.age-stat strong{color:var(--text)}

/* ABILITIES */
.ability-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:8px}
.ab-box{background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:14px 6px 12px;text-align:center}
.ab-abbr{font-family:'Cinzel',serif;font-size:.7rem;font-weight:700;letter-spacing:.1em;color:var(--gold-dim);margin-bottom:3px}
.ab-full{font-size:.68rem;color:var(--muted);margin-bottom:10px;line-height:1.3;min-height:28px}
.ab-ctrl{display:flex;align-items:center;justify-content:center;gap:6px}
.ab-btn{width:26px;height:26px;border-radius:50%;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;line-height:1;flex-shrink:0}
.ab-btn:hover:not(:disabled){border-color:var(--amber);color:var(--amber)}
.ab-btn:disabled{opacity:.2;cursor:not-allowed}
.ab-val{font-family:'Cinzel',serif;font-size:1.35rem;font-weight:700;min-width:32px;color:var(--text);transition:color .15s}
.ab-val.pos{color:#4caf7d}
.ab-val.neg{color:#e05a4a}
.pts-bar{display:flex;align-items:center;gap:10px;margin-bottom:18px}
.pts-lbl{font-family:'Cinzel',serif;font-size:.7rem;letter-spacing:.12em;color:var(--muted2)}
.pts-cnt{font-family:'Cinzel',serif;font-size:1.1rem;color:var(--gold)}
.derived-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:18px}
.derived-box{background:var(--card2);border:1px solid var(--border);border-radius:3px;padding:12px;text-align:center}
.derived-lbl{font-family:'Cinzel',serif;font-size:.58rem;letter-spacing:.18em;text-transform:uppercase;color:var(--muted);margin-bottom:4px}
.derived-val{font-family:'Cinzel',serif;font-size:1.7rem;font-weight:700;color:var(--gold)}
.derived-form{font-size:.7rem;color:var(--muted);margin-top:1px}

/* SKILLS */
.skill-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px}
.skill-chip{padding:8px 10px;border:1px solid var(--border);border-radius:2px;background:var(--surface);color:var(--muted2);font-family:'Crimson Pro',serif;font-size:.93rem;cursor:pointer;transition:all .15s;text-align:center;user-select:none}
.skill-chip:hover:not(.locked){border-color:var(--amber);color:var(--text)}
.skill-chip.sel{border-color:var(--gold);color:var(--gold);background:rgba(232,184,75,.07)}
.skill-chip.locked:not(.sel){opacity:.28;cursor:not-allowed}
.tally{font-family:'Cinzel',serif;font-size:.72rem;color:var(--muted2);margin-bottom:16px}
.tally span{color:var(--gold)}

/* TALENTS */
.filter-row{display:flex;gap:7px;margin-bottom:18px;flex-wrap:wrap}
.f-btn{padding:5px 13px;border-radius:20px;border:1px solid var(--border);background:var(--surface);color:var(--muted);font-family:'Cinzel',serif;font-size:.6rem;letter-spacing:.1em;cursor:pointer;transition:all .15s}
.f-btn:hover{border-color:var(--amber);color:var(--text)}
.f-btn.a{border-color:transparent;color:#fff}
.f-btn.a.all{background:var(--amber)}
.f-btn.a.off{background:#a93226}
.f-btn.a.def{background:#1f618d}
.f-btn.a.util{background:#1e8449}
.f-btn.a.myst{background:#6c3483}
.talent-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:9px}
.t-card{background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:13px 14px;cursor:pointer;transition:all .15s;position:relative}
.t-card:hover:not(.locked){border-color:var(--amber)}
.t-card.sel{border-color:var(--gold);background:rgba(232,184,75,.05)}
.t-card.locked:not(.sel){opacity:.3;cursor:not-allowed}
.t-name{font-family:'Cinzel',serif;font-size:.78rem;font-weight:700;color:var(--gold-dim);margin-bottom:4px;padding-right:60px}
.t-card.sel .t-name{color:var(--gold)}
.t-desc{font-size:.81rem;color:var(--muted2);line-height:1.4}
.t-tag{position:absolute;top:10px;right:10px;font-family:'Cinzel',serif;font-size:.5rem;letter-spacing:.1em;padding:2px 6px;border-radius:10px;border:1px solid;opacity:.65}

/* SPELL PICKER */
.school-tabs{display:flex;gap:0;margin-bottom:14px;border:1px solid var(--border);border-radius:3px;overflow:hidden}
.s-tab{flex:1;padding:8px;text-align:center;font-family:'Cinzel',serif;font-size:.65rem;letter-spacing:.1em;cursor:pointer;background:var(--surface);color:var(--muted);border:none;transition:all .15s;border-right:1px solid var(--border)}
.s-tab:last-child{border-right:none}
.s-tab:hover{color:var(--text)}
.s-tab.a{background:var(--card2);color:var(--gold)}
.spell-warn{background:rgba(192,57,43,.1);border:1px solid rgba(192,57,43,.3);border-radius:3px;padding:9px 13px;font-size:.85rem;color:#e07060;margin-bottom:12px;font-style:italic}
.spell-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:7px;max-height:300px;overflow-y:auto;padding-right:3px}
.spell-grid::-webkit-scrollbar{width:3px}
.spell-grid::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
.sp-item{background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:9px 11px;cursor:pointer;transition:all .15s}
.sp-item:hover{border-color:var(--amber)}
.sp-item.sel{border-color:var(--gold);background:rgba(232,184,75,.06)}
.sp-tier{font-family:'Cinzel',serif;font-size:.52rem;letter-spacing:.15em;color:var(--muted);margin-bottom:2px}
.sp-name{font-family:'Cinzel',serif;font-size:.75rem;color:var(--gold-dim)}
.sp-item.sel .sp-name{color:var(--gold)}
.sp-desc{font-size:.76rem;color:var(--muted);margin-top:2px;line-height:1.3}

/* EQUIPMENT */
.gold-panel{display:flex;align-items:center;gap:14px;background:var(--card2);border:1px solid var(--border);border-radius:3px;padding:16px;margin-bottom:20px;flex-wrap:wrap}
.gold-amt{font-family:'Cinzel',serif;font-size:1.5rem;font-weight:700;color:var(--gold);min-width:50px}
.gold-inp{width:90px;font-family:'Cinzel',serif;font-size:1rem;text-align:center;padding:7px 10px}
.btn-roll{padding:8px 16px;background:var(--card2);border:1px solid var(--amber);border-radius:2px;color:var(--amber);font-family:'Cinzel',serif;font-size:.65rem;letter-spacing:.1em;cursor:pointer;transition:all .15s}
.btn-roll:hover{background:rgba(200,130,10,.15)}
.gold-remaining{font-family:'Cinzel',serif;font-size:.8rem;color:var(--muted2)}
.gold-remaining span{color:var(--gold)}
.eq-cats{display:flex;gap:7px;margin-bottom:14px;flex-wrap:wrap}
.ec-btn{padding:5px 13px;border-radius:20px;border:1px solid var(--border);background:var(--surface);color:var(--muted);font-family:'Cinzel',serif;font-size:.6rem;letter-spacing:.08em;cursor:pointer;transition:all .15s}
.ec-btn:hover{border-color:var(--amber);color:var(--text)}
.ec-btn.a{border-color:var(--gold);color:var(--gold);background:rgba(232,184,75,.07)}
.eq-wrap{max-height:360px;overflow-y:auto;border:1px solid var(--border);border-radius:3px}
.eq-wrap::-webkit-scrollbar{width:3px}
.eq-wrap::-webkit-scrollbar-thumb{background:var(--border2)}
table.eq-tbl{width:100%;border-collapse:collapse;font-size:.87rem}
table.eq-tbl th{font-family:'Cinzel',serif;font-size:.58rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);text-align:left;padding:8px 10px;border-bottom:1px solid var(--border);background:var(--card2);position:sticky;top:0}
table.eq-tbl td{padding:7px 10px;border-bottom:1px solid rgba(58,42,14,.4);vertical-align:top;color:var(--text)}
table.eq-tbl tr:hover td{background:rgba(232,184,75,.02)}
.eq-n{font-weight:600}
.eq-p{color:var(--muted2);font-size:.8rem;font-style:italic}
.eq-c{font-family:'Cinzel',serif;color:var(--gold-dim);white-space:nowrap}
.eq-add{padding:3px 9px;border:1px solid var(--border2);border-radius:2px;background:var(--card);color:var(--muted2);font-family:'Cinzel',serif;font-size:.58rem;letter-spacing:.06em;cursor:pointer;transition:all .15s;white-space:nowrap}
.eq-add:hover:not(:disabled){border-color:var(--amber);color:var(--amber)}
.eq-add:disabled{opacity:.2;cursor:not-allowed}
.cart{margin-top:20px;background:var(--card2);border:1px solid var(--border);border-radius:3px;padding:18px}
.cart-ttl{font-family:'Cinzel',serif;font-size:.65rem;letter-spacing:.18em;text-transform:uppercase;color:var(--muted2);margin-bottom:12px;border-bottom:1px solid var(--border);padding-bottom:7px}
.cart-item{display:flex;align-items:center;padding:6px 0;border-bottom:1px solid rgba(58,42,14,.35);font-size:.88rem}
.cart-item:last-child{border-bottom:none}
.ci-name{flex:1;color:var(--text)}
.ci-cost{font-family:'Cinzel',serif;color:var(--gold-dim);font-size:.83rem;margin:0 10px}
.ci-rm{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.95rem;padding:0 3px;transition:color .15s}
.ci-rm:hover{color:var(--red)}
.cart-sum{display:flex;justify-content:space-between;padding-top:10px;font-family:'Cinzel',serif;font-size:.75rem;letter-spacing:.1em;color:var(--muted2)}
.cart-sum span{color:var(--gold)}

/* DICE CHAINS */
.links-bar{display:flex;align-items:center;gap:10px;margin-bottom:18px}
.links-lbl{font-family:'Cinzel',serif;font-size:.7rem;letter-spacing:.12em;color:var(--muted2)}
.links-cnt{font-family:'Cinzel',serif;font-size:1.1rem;color:var(--gold)}
.chain-item{background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:12px 14px;margin-bottom:9px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.chain-name{font-family:'Cinzel',serif;font-size:.78rem;color:var(--gold-dim);min-width:130px}
.die-row{display:flex;gap:4px;align-items:center}
.die-pip{width:34px;height:34px;border:1px solid var(--border);border-radius:3px;display:flex;align-items:center;justify-content:center;font-family:'Cinzel',serif;font-size:.62rem;color:var(--muted);transition:all .15s}
.die-pip.unl{border-color:var(--amber);color:var(--amber);background:rgba(200,130,10,.07)}
.die-pip.cur{border-color:var(--gold);color:#000;background:var(--amber)}
.chain-ctrl{display:flex;gap:5px}
.ch-btn{width:26px;height:26px;border-radius:3px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:.95rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.ch-btn:hover:not(:disabled){border-color:var(--amber);color:var(--amber)}
.ch-btn:disabled{opacity:.2;cursor:not-allowed}
.no-chains{text-align:center;color:var(--muted);font-style:italic;padding:28px;font-size:.93rem}

/* WARN/INFO */
.warn-box{background:rgba(192,57,43,.08);border:1px solid rgba(192,57,43,.25);border-radius:3px;padding:9px 13px;color:#e07060;font-size:.85rem;font-style:italic;margin-top:10px}
.info-box{background:rgba(232,184,75,.05);border:1px solid rgba(232,184,75,.18);border-radius:3px;padding:9px 13px;color:var(--muted2);font-size:.85rem;font-style:italic;margin-top:10px}

/* NAV */
.nav-row{display:flex;align-items:center;justify-content:space-between;margin-top:28px;gap:10px}
.btn{padding:11px 28px;border-radius:2px;border:1px solid;font-family:'Cinzel',serif;font-size:.7rem;font-weight:700;letter-spacing:.14em;text-transform:uppercase;cursor:pointer;transition:all .2s}
.btn-primary{background:var(--amber);border-color:var(--amber);color:#000}
.btn-primary:hover:not(:disabled){background:var(--gold);border-color:var(--gold)}
.btn-primary:disabled{opacity:.35;cursor:not-allowed}
.btn-sec{background:transparent;border-color:var(--border2);color:var(--muted2)}
.btn-sec:hover{border-color:var(--muted2);color:var(--text)}
.btn-ghost{background:transparent;border-color:var(--gold-dim);color:var(--gold-dim)}
.btn-ghost:hover{border-color:var(--gold);color:var(--gold)}

/* CHARACTER SHEET */
#sheet{background:#f0e6cc;color:#1a0f02;font-family:'Crimson Pro',serif;border:1px solid var(--border2);border-radius:3px;overflow:hidden;margin-bottom:20px}
.sh-inner{padding:24px;background:#f0e6cc;position:relative}
.sh-topbar{background:#1a0f02;color:#e8b84b;padding:9px 16px;display:flex;align-items:center;justify-content:space-between}
.sh-game{font-family:'Cinzel',serif;font-size:.95rem;font-weight:900;letter-spacing:.07em}
.sh-ed{font-family:'Cinzel',serif;font-size:.55rem;letter-spacing:.2em;color:#9e7228}
.sh-row{display:flex;gap:0;border:1px solid #8a6030;border-radius:2px;margin-bottom:9px;overflow:hidden}
.sh-f{flex:1;border-right:1px solid #8a6030;display:flex;flex-direction:column}
.sh-f:last-child{border-right:none}
.sh-fl{font-family:'Cinzel',serif;font-size:.53rem;letter-spacing:.15em;text-transform:uppercase;color:#6a4820;background:#e8d8b0;padding:3px 8px;border-bottom:1px solid #c4a060}
.sh-fv{padding:5px 8px;font-size:.93rem;color:#1a0f02;min-height:26px}
.sh-fv.lg{font-family:'Cinzel',serif;font-size:1.3rem;font-weight:700;text-align:center;display:flex;align-items:center;justify-content:center;min-height:40px}
/* abilities */
.sh-abs{display:grid;grid-template-columns:repeat(5,1fr);gap:7px;margin-bottom:9px}
.sh-ab{border:2px solid #8a6030;border-radius:2px;text-align:center;overflow:hidden}
.sh-ab-n{background:#1a0f02;color:#e8b84b;font-family:'Cinzel',serif;font-size:.65rem;font-weight:700;letter-spacing:.08em;padding:3px}
.sh-ab-v{font-family:'Cinzel',serif;font-size:1.8rem;font-weight:900;padding:8px 4px;color:#1a0f02}
.sh-ab-c{background:#e8d8b0;border-top:1px solid #c4a060;font-family:'Cinzel',serif;font-size:.47rem;letter-spacing:.07em;color:#6a4820;padding:2px}
/* vitals */
.sh-vitals{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;margin-bottom:9px}
.sh-vit{border:1px solid #8a6030;border-radius:2px;text-align:center;overflow:hidden}
.sh-vit-n{background:#1a0f02;color:#e8b84b;font-family:'Cinzel',serif;font-size:.58rem;font-weight:700;letter-spacing:.14em;padding:4px}
.sh-vit-v{font-family:'Cinzel',serif;font-size:1.5rem;font-weight:900;padding:9px;color:#1a0f02}
.sh-vit-f{background:#e8d8b0;border-top:1px solid #c4a060;font-size:.58rem;color:#6a4820;padding:2px;font-family:'Cinzel',serif}
/* columns */
.sh-cols{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:9px}
.sh-sec{border:1px solid #8a6030;border-radius:2px;overflow:hidden}
.sh-sec-t{background:#1a0f02;color:#e8b84b;font-family:'Cinzel',serif;font-size:.6rem;font-weight:700;letter-spacing:.17em;text-transform:uppercase;padding:4px 10px}
.sh-sec-b{padding:7px 10px}
.sh-line{border-bottom:1px solid #c4a060;padding:4px 2px;font-size:.86rem;color:#1a0f02;min-height:23px}
.sh-line:last-child{border-bottom:none}
/* hero dice */
.sh-dice{display:flex;gap:5px;padding:7px 10px;flex-wrap:wrap}
.sh-die{width:34px;height:34px;border:2px solid #8a6030;border-radius:3px;display:flex;align-items:center;justify-content:center;font-family:'Cinzel',serif;font-size:.6rem;font-weight:700;color:#4a2e08;background:#e8d8b0}
/* conviction */
.sh-conv{border:1px solid #8a6030;border-radius:2px;margin-bottom:9px;overflow:hidden}
.sh-conv-b{padding:7px 10px;font-style:italic;font-size:.92rem;color:#1a0f02;min-height:38px}
/* inventory */
.sh-inv{border:1px solid #8a6030;border-radius:2px;overflow:hidden;margin-bottom:9px}
.sh-inv-r{display:flex;gap:0;border-bottom:1px solid #c4a060}
.sh-inv-r:last-child{border-bottom:none}
.sh-inv-n{font-family:'Cinzel',serif;font-size:.58rem;color:#6a4820;padding:4px 7px;border-right:1px solid #c4a060;min-width:26px;display:flex;align-items:center;justify-content:center;background:#e8d8b0}
.sh-inv-i{flex:1;padding:4px 8px;font-size:.86rem;color:#1a0f02}
/* EOS */
.sh-eos{border:1px solid #8a6030;border-radius:2px;overflow:hidden}
.sh-eos-q{display:flex;align-items:center;gap:7px;padding:3px 10px;border-bottom:1px solid #c4a060;font-size:.72rem;color:#4a2e08;font-family:'Cinzel',serif}
.sh-eos-q:last-child{border-bottom:none}
.eos-dot{width:10px;height:10px;border-radius:50%;border:1.5px solid #8a6030;flex-shrink:0}
/* conditions */
.sh-conds{display:grid;grid-template-columns:1fr 1fr;gap:5px;padding:7px 10px}
.sh-cond{display:flex;align-items:center;gap:5px;font-family:'Cinzel',serif;font-size:.6rem;letter-spacing:.07em;color:#4a2e08}
.cond-c{width:11px;height:11px;border-radius:50%;border:1.5px solid #8a6030;flex-shrink:0}

/* UTIL */
.hidden{display:none!important}
</style>
</head>
<body>
<div id="app">

<div class="site-header">
  <div class="eyebrow">Jaunskungu Edicija · Beta v0.8</div>
  <div class="main-title">Dzintaru Dziesmas</div>
  <div class="main-sub">Character Creator</div>
</div>

<!-- STEP NAVIGATOR -->
<div class="steps-nav" id="stepsNav"></div>

<!-- STEP PANELS -->
<div id="steps-wrap"></div>

<!-- NAV BUTTONS -->
<div class="nav-row">
  <button class="btn btn-sec" id="btnBack">← Back</button>
  <button class="btn btn-primary" id="btnNext">Continue →</button>
</div>

</div><!-- /app -->

<script>
// ═══════════════════════════════════════════════════════════
// DATA
// ═══════════════════════════════════════════════════════════

const AGE = {
  Young: {points:12, skills:2, links:2},
  Adult: {points:10, skills:3, links:3},
  Old:   {points:8,  skills:4, links:4}
};

const ABILITY_META = [
  {id:'STR', full:'Strength',     desc:'Melee attacks, HP, Item Slots'},
  {id:'DEX', full:'Dexterity',    desc:'Ranged attacks'},
  {id:'INT', full:'Intellect',    desc:'Supply, Arcane Spells'},
  {id:'WIL', full:'Willpower',    desc:'HP, Primal Magic'},
  {id:'CHA', full:'Charisma',     desc:'Divine Miracles'},
];

const SKILLS = [
  'Acrobatics','Anatomy','Animal Handling','Arcana','Athletics',
  'Awareness','Crafting','Deception','Insight','Leadership',
  'Lore and Songs','Persuasion','Sleight of Hand','Stealth','Survival'
];

const TALENT_CATS = {
  Offensive:'#a93226', Defensive:'#1f618d',
  Utility:'#1e8449',   Mystique:'#6c3483'
};

const TALENTS = [
  {id:'frenzied',    cat:'Offensive', name:'Frenzied',            chain:false, desc:'Add last damage taken to next Ability Check. Points above 20 deal extra damage.'},
  {id:'bloodthirst', cat:'Offensive', name:'Bloodthirst',         chain:false, desc:"Each time you destroy a Foe, quickly roll damage again."},
  {id:'iron_grip',   cat:'Offensive', name:'Iron Grip',           chain:false, desc:'Hold a two-handed weapon in one hand.'},
  {id:'dual_wield',  cat:'Offensive', name:'Dual Wield',          chain:false, desc:'Wield 2 weapons at once. Roll both damage dice and pick the highest.'},
  {id:'unorthodox',  cat:'Offensive', name:'Unorthodox Style',    chain:false, desc:'Wield all weapons with DEX, but max DC is d8.'},
  {id:'soulbound',   cat:'Offensive', name:'Soulbound Weapon',    chain:false, desc:'Name a weapon. Add STR or DEX to its damage. Deep emotional bond.'},
  {id:'zealous',     cat:'Offensive', name:'Zealous Smite',       chain:false, desc:'Sacrifice any HP to gain twice that amount as extra damage.'},
  {id:'backstab',    cat:'Offensive', name:'Backstab',            chain:false, desc:'Always deal Critical damage on successful stealthed attacks.'},
  {id:'vanish',      cat:'Offensive', name:'Vanish',              chain:false, desc:'After a successful Negate, you are stealthed from the foe that missed.'},
  {id:'oils',        cat:'Offensive', name:'Stinging Oils',       chain:false, desc:'After hitting, spend Supply to poison target for 1 Round per Supply spent.'},
  {id:'cutting',     cat:'Offensive', name:'Cutting Words',       chain:false, desc:'Attack with CHA insults. Roll 1d4+CHA for damage. Cannot kill.'},
  {id:'fist',        cat:'Offensive', name:'Striking Fist',       chain:true,  chainName:'Striking Fist', desc:'Fists deal [D] damage. Attack with STR or DEX.'},
  {id:'hectic',      cat:'Offensive', name:'Hectic Slay',         chain:false, desc:'Add Adrenaline to damage roll, then spend one Adrenaline.'},
  {id:'tough',       cat:'Defensive', name:'Tough',               chain:false, desc:'Increase your Max HP by 5 points.'},
  {id:'iron_skin',   cat:'Defensive', name:'Iron Skin',           chain:false, desc:'When wearing no armor, your AC is 2.'},
  {id:'lightning',   cat:'Defensive', name:'Lightning Speed',     chain:false, desc:'Move faster than common folk. Can never be surprised.'},
  {id:'dodging',     cat:'Defensive', name:'Dodging Death',       chain:false, desc:'Roll Death Saves with Advantage.'},
  {id:'reinforce',   cat:'Defensive', name:'Reinforced Confidence',chain:false,desc:'When you reduce all incoming damage to 0, recover HP equal to WIL.'},
  {id:'redirect',    cat:'Defensive', name:'Redirect Energy',     chain:false, desc:'After a successful Negate, redirect damage to any target besides attacker.'},
  {id:'numbing',     cat:'Defensive', name:'Numbing Pain',        chain:false, desc:'Deduct Adrenaline from incoming damage (after AC), then spend 1 Adrenaline.'},
  {id:'beast',       cat:'Utility',   name:'Beast Master',        chain:false, desc:'Train a loyal animal. It acts on your turn. HP: 10 | Damage: [D].'},
  {id:'remedies',    cat:'Utility',   name:'Healing Remedies',    chain:true,  chainName:'Healing Remedy', desc:'Convert Supply into herbs and pastes that heal [D].'},
  {id:'dominate',    cat:'Utility',   name:'Dominating Presence', chain:false, desc:'Conviction rolls use 3d6 and take the 2 highest numbers.'},
  {id:'camaraderie', cat:'Utility',   name:'Camaraderie',         chain:false, desc:'Use your Hero Die on other players\' die rolls.'},
  {id:'resourceful', cat:'Utility',   name:'Resourceful',         chain:false, desc:'Carry [10 + INT] Supply instead of the normal amount.'},
  {id:'disciplined', cat:'Utility',   name:'Disciplined',         chain:false, desc:'Whenever you roll your Hero Die, roll with Advantage.'},
  {id:'pressure',    cat:'Utility',   name:'High Pressure',       chain:false, desc:'Rolling maximum on a Hero Die regains lowest spent HD instead of spending it.'},
  {id:'cook',        cat:'Utility',   name:'Precious Cook',       chain:false, desc:'Spend 1 hour cooking. 1 portion per Supply: remove Condition, Wound, or regain HD.'},
  {id:'spellcast',   cat:'Mystique',  name:'Spellcasting',        chain:false, desc:'You can cast spells. When you pick this, also choose one starting spell.'},
  {id:'cantrips',    cat:'Mystique',  name:'Cantrips',            chain:false, desc:'Memorized spells can be cast without occupying an Inventory Slot.'},
  {id:'blood_runes', cat:'Mystique',  name:'Blood Runes',         chain:false, desc:'Carve runes into your flesh. Spellcasting costs 1 Supply less.'},
  {id:'wild_magic',  cat:'Mystique',  name:'Wild Magic',          chain:false, desc:'Add an extra Spell Die to the roll, then roll on the Wild Magic table.'},
  {id:'divination',  cat:'Mystique',  name:'Divination',          chain:false, desc:'After Downtime, roll d20 and note result. Replace any one roll at the table.'},
  {id:'hibernate',   cat:'Mystique',  name:'Hibernate',           chain:false, desc:'Enter hibernation to halt metabolism and aging.'},
  {id:'sense_evil',  cat:'Mystique',  name:'Sense Evil',          chain:false, desc:'Focus your senses and detect evil, like a rot in the air.'},
  {id:'mesmerize',   cat:'Mystique',  name:'Mesmerizing',         chain:false, desc:'Almost always welcomed. People cannot seem to turn you away.'},
  {id:'razzle',      cat:'Mystique',  name:'Razzle-Dazzle',       chain:false, desc:'Spend Supply to perform a flashy trick. Confuse, mesmerize, and trick others.'},
  {id:'wildskin',    cat:'Mystique',  name:'Wildskin',            chain:false, desc:'Spend 1 Supply and turn into a familiar animal.'},
  {id:'natures',     cat:'Mystique',  name:"Nature's Wrath",      chain:true,  chainName:"Nature's Wrath", desc:'Use nature as a weapon. Attack with WIL, deal [D] damage.'},
  {id:'lucky',       cat:'Mystique',  name:'Lucky',               chain:false, desc:'When rolling on Random Tables, roll twice and pick your preferred result.'},
  {id:'pressure_cast',cat:'Mystique', name:'Pressure Casting',    chain:false, desc:'Add Adrenaline to your Spell roll, then spend 1 Adrenaline.'},
  {id:'alchemy',     cat:'Mystique',  name:'Alchemy',             chain:false, desc:'Turn any 3 Rare Ingredients into a potion, poison, or antidote.'},
];

const SPELLS = {
  Arcane: [
    {tier:'Cantrip', name:'Detect Magic',       desc:'Sense magical auras within 30ft.'},
    {tier:'Cantrip', name:'Illusion',            desc:'Create a small sensory illusion.'},
    {tier:'Cantrip', name:'Mage Hand',           desc:'Telekinetically move small objects.'},
    {tier:'Cantrip', name:'Light',               desc:'Object glows bright light in 20ft radius.'},
    {tier:'Rank I',  name:'Animate Object',      desc:'Bring an object to life to fight for you.'},
    {tier:'Rank I',  name:'Charm',               desc:'Target treats you as a trusted friend.'},
    {tier:'Rank I',  name:'Dispel',              desc:'End one magical effect.'},
    {tier:'Rank I',  name:'Fog',                 desc:'Fill area with thick concealing mist.'},
    {tier:'Rank I',  name:'Knock',               desc:'Unlock any lock, mundane or magical.'},
    {tier:'Rank I',  name:'Mirror Image',        desc:'Create 3 duplicates of yourself.'},
    {tier:'Rank I',  name:'Shield',              desc:'Magical barrier adds +3 AC until next turn.'},
    {tier:'Rank II', name:'Fireball',            desc:'Explosive burst of fire in 20ft radius.'},
    {tier:'Rank II', name:'Fly',                 desc:'Grant flight to yourself or one touched creature.'},
    {tier:'Rank II', name:'Invisibility',        desc:'Target becomes invisible until they attack.'},
    {tier:'Rank II', name:'Lightning Bolt',      desc:'Line of lightning 100ft long, 5ft wide.'},
    {tier:'Rank II', name:'Polymorph',           desc:'Transform target into another creature.'},
    {tier:'Rank II', name:'Teleport',            desc:'Instantly travel to a known location.'},
    {tier:'Rank III',name:'Time Stop',           desc:'Freeze time for everyone but yourself.'},
    {tier:'Rank III',name:'Wish',                desc:'Alter reality. The GM decides what that means.'},
  ],
  Miracles: [
    {tier:'Cantrip', name:'Guidance',            desc:'Add d4 to one ability check.'},
    {tier:'Cantrip', name:'Sacred Flame',        desc:'Radiant flame, auto-hits, deals [D].'},
    {tier:'Cantrip', name:'Thaumaturgy',         desc:'Minor miracle: voice booms, eyes glow, etc.'},
    {tier:'Rank I',  name:'Bless',               desc:'Up to 3 creatures add d4 to checks & saves.'},
    {tier:'Rank I',  name:'Command',             desc:'One-word divine command. Target must obey.'},
    {tier:'Rank I',  name:'Cure Wounds',         desc:'Touch to heal [D]+CHA HP.'},
    {tier:'Rank I',  name:"Divine Favor",        desc:'Weapon attacks deal extra d4 radiant.'},
    {tier:'Rank I',  name:'Shield of Faith',     desc:'+2 AC to touched creature for 10 minutes.'},
    {tier:'Rank II', name:'Revivify',            desc:'Restore life to creature dead less than 1 min.'},
    {tier:'Rank II', name:'Speak With Dead',     desc:'Ask 5 questions of a corpse.'},
    {tier:'Rank II', name:'Banishment',          desc:'Banish target to their home plane.'},
    {tier:'Rank II', name:'Divine Wrath',        desc:'Call down divine energy: 8d6 in 30ft radius.'},
    {tier:'Rank III',name:'Resurrection',        desc:'Fully restore life to the recently dead.'},
    {tier:'Rank III',name:"Deity's Intervention",desc:'Your deity personally intervenes.'},
  ],
  Primal: [
    {tier:'Cantrip', name:'Druidcraft',          desc:'Minor nature magic: predict weather, bloom.'},
    {tier:'Cantrip', name:'Shillelagh',          desc:'Staff deals [D]+WIL damage.'},
    {tier:'Cantrip', name:'Thorn Whip',          desc:'Vine lash pulls target 10ft toward you.'},
    {tier:'Rank I',  name:'Animal Friendship',   desc:'Charm a beast to be your ally.'},
    {tier:'Rank I',  name:'Entangle',            desc:'Vines erupt, restraining creatures in 20ft.'},
    {tier:'Rank I',  name:'Faerie Fire',         desc:'Outline creatures in light; attacks have Adv.'},
    {tier:'Rank I',  name:'Healing Word',        desc:'Bonus action heal: [D]+WIL HP to target.'},
    {tier:'Rank I',  name:'Speak With Animals',  desc:'Communicate with beasts for 10 minutes.'},
    {tier:'Rank II', name:'Barkskin',            desc:'AC cannot drop below 16.'},
    {tier:'Rank II', name:"Call Lightning",      desc:'Storm cloud hurls lightning bolts.'},
    {tier:'Rank II', name:'Reincarnate',         desc:'Dead creature returns as new body (random race).'},
    {tier:'Rank II', name:'Stoneskin',           desc:'Resistance to non-magical physical damage.'},
    {tier:'Rank III',name:'Earthquake',          desc:'Violent shaking collapses structures, breaks terrain.'},
    {tier:'Rank III',name:'Shapechange',         desc:'Become any beast or creature you have seen.'},
  ]
};

const SPELL_ABILITY = {Arcane:'INT', Miracles:'CHA', Primal:'WIL'};

const EQUIPMENT = {
  'Weapons': [
    {name:'Dagger',       props:'Light, Throwable',                slots:1, cost:5,  weapon:true},
    {name:'Hand Axe',     props:'Light, Throwable',                slots:1, cost:6,  weapon:true},
    {name:'Short Sword',  props:'Light',                           slots:1, cost:10, weapon:true},
    {name:'Arming Sword', props:'One-handed',                      slots:1, cost:15, weapon:true},
    {name:'Battle Axe',   props:'One-handed',                      slots:1, cost:14, weapon:true},
    {name:'Mace',         props:'One-handed',                      slots:1, cost:12, weapon:true},
    {name:'Spear',        props:'One-handed or Two-handed, Reach',  slots:2, cost:10, weapon:true},
    {name:'Long Sword',   props:'Two-handed',                      slots:2, cost:22, weapon:true},
    {name:'Great Axe',    props:'Two-handed',                      slots:2, cost:20, weapon:true},
    {name:'Polearm',      props:'Two-handed, Reach',               slots:2, cost:18, weapon:true},
    {name:'Short Bow',    props:'Ranged, Two-handed',              slots:2, cost:15, weapon:true},
    {name:'Long Bow',     props:'Ranged, Two-handed',              slots:2, cost:25, weapon:true},
    {name:'Hand Crossbow',props:'Ranged, Light',                   slots:1, cost:20, weapon:true},
    {name:'Crossbow',     props:'Ranged, Heavy, Two-handed',       slots:2, cost:30, weapon:true},
    {name:'Staff',        props:'Two-handed, Arcane Focus',        slots:2, cost:8,  weapon:true},
    {name:'Javelin',      props:'Throwable, Reach',                slots:1, cost:4,  weapon:true},
  ],
  'Armor & Shields': [
    {name:'Buckler',      props:'Shield, Light',                   slots:1, cost:10, shield:true},
    {name:'Shield',       props:'Shield, Standard',                slots:1, cost:15, shield:true},
    {name:'Tower Shield', props:'Shield, Heavy, -1 DEX',          slots:2, cost:25, shield:true},
    {name:'Light Armor',  props:'AC 2',                            slots:2, cost:20, armor:true},
    {name:'Medium Armor', props:'AC 4, -1 DEX',                   slots:3, cost:40, armor:true},
    {name:'Heavy Armor',  props:'AC 6, -2 DEX',                   slots:4, cost:80, armor:true},
  ],
  'Adventuring Gear': [
    {name:'Rope (50ft)',       props:'—',          slots:1, cost:2},
    {name:'Torch (x3)',        props:'1 hour each', slots:1, cost:1},
    {name:'Lantern',           props:'Oil lamp',    slots:1, cost:5},
    {name:'Oil Flask',         props:'—',           slots:1, cost:2},
    {name:'Rations (x5)',      props:'1 day each',  slots:1, cost:3},
    {name:'Medicine Kit',      props:'Full HP, 1 use', slots:1, cost:15},
    {name:'Antitoxin',         props:'Cures poison',   slots:1, cost:10},
    {name:'Lockpicks',         props:'Thieves tools',  slots:1, cost:12},
    {name:'Grappling Hook',    props:'—',              slots:1, cost:8},
    {name:'Crowbar',           props:'—',              slots:1, cost:4},
    {name:'10ft Pole',         props:'—',              slots:1, cost:1},
    {name:'Shovel',            props:'—',              slots:1, cost:3},
    {name:'Backpack',          props:'+4 Item Slots',  slots:0, cost:8},
    {name:'Bedroll',           props:'—',              slots:1, cost:4},
    {name:'Blanket',           props:'—',              slots:1, cost:2},
    {name:'Flint & Steel',     props:'—',              slots:1, cost:1},
    {name:'Chalk (x10)',       props:'—',              slots:1, cost:1},
    {name:'Ink & Quill',       props:'Writing tools',  slots:1, cost:3},
    {name:'Parchment (x5)',    props:'—',              slots:1, cost:2},
    {name:'Mirror (small)',    props:'Signal mirror',  slots:1, cost:5},
    {name:'Spyglass',          props:'—',              slots:1, cost:25},
    {name:'Map Case',          props:'Waterproof',     slots:1, cost:6},
    {name:'Disguise Kit',      props:'—',              slots:1, cost:20},
    {name:'Alchemist Supplies',props:'Crafting',       slots:2, cost:30},
    {name:'Herbalist Kit',     props:'For Remedies',   slots:1, cost:12},
    {name:'Holy Symbol',       props:'Divine focus',   slots:1, cost:10},
    {name:'Manacles',          props:'—',              slots:1, cost:5},
    {name:'Caltrops (bag)',    props:'Difficult terrain',slots:1, cost:3},
    {name:'Bear Trap',         props:'—',              slots:2, cost:8},
    {name:'Fishing Kit',       props:'—',              slots:1, cost:4},
    {name:'Magnifying Glass',  props:'—',              slots:1, cost:15},
    {name:'Signal Horn',       props:'—',              slots:1, cost:8},
    {name:'Climbers Kit',      props:'—',              slots:2, cost:18},
    {name:'Supply (x1)',       props:'One Supply unit', slots:1, cost:2},
  ],
  'Vehicles & Mounts': [
    {name:'Draft Horse',   props:'Pull 2,000 lbs',              slots:0, cost:50},
    {name:'Riding Horse',  props:'Speed: Fast',                 slots:0, cost:75},
    {name:'Warhorse',      props:'Speed: Fast, Combat trained', slots:0, cost:200},
    {name:'Mule',          props:'Pull 1,000 lbs, Stubborn',    slots:0, cost:20},
    {name:'Pony',          props:'Small riders',                slots:0, cost:30},
    {name:'Cart',          props:'Carries 1,000 lbs',           slots:0, cost:25},
    {name:'Wagon',         props:'Carries 4,000 lbs',           slots:0, cost:60},
    {name:'Rowboat',       props:'4 passengers',                slots:0, cost:30},
    {name:'Keelboat',      props:'15 passengers',               slots:0, cost:300},
    {name:'Saddle',        props:'For riding horse',            slots:1, cost:15},
    {name:'Saddlebags',    props:'+4 Item Slots on mount',      slots:0, cost:8},
  ],
  'Rare Ingredients': [
    {name:"Dragon's Blood",     props:'Alchemical, Rare',     slots:1, cost:80},
    {name:'Moonpetal Flower',   props:'Alchemical, Rare',     slots:1, cost:50},
    {name:'Void Crystal Shard', props:'Arcane, Very Rare',    slots:1, cost:120},
    {name:'Phoenix Feather',    props:'Alchemical, Very Rare',slots:1, cost:150},
    {name:'Troll Fat',          props:'Alchemical, Uncommon', slots:1, cost:30},
    {name:'Mandrake Root',      props:'Herbal, Uncommon',     slots:1, cost:25},
    {name:'Sunstone Dust',      props:'Arcane, Uncommon',     slots:1, cost:35},
    {name:'Basilisk Eye',       props:'Alchemical, Rare',     slots:1, cost:70},
    {name:'Ghostmoss',          props:'Herbal, Common',       slots:1, cost:10},
    {name:'Ironbark Sap',       props:'Herbal, Common',       slots:1, cost:8},
  ]
};

const DICE_STEPS = ['d4','d6','d8','d10','d12'];

const EOS_QUESTIONS = [
  'Did you attend the session?',
  'Did you finish a quest?',
  'Did you obtain treasure?',
  'Did you uphold your Conviction?',
  'Did you discover a location?',
  'Did you roll a Death Save?',
  'Did you roll a Natural 20?',
  'Did you roll a Natural 1?',
  'Did you Aid another Hero?'
];

const STEP_NAMES = ['Concept','Age','Abilities','Skills','Talents','Equipment','Dice Chains','Character Sheet'];
const STEP_COUNT = STEP_NAMES.length;

// ═══════════════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════════════

const state = {
  step: 0,
  // concept
  name:'', descriptor:'', roots:'', conviction:'',
  // age
  age: null,
  // abilities
  abilities: {STR:-2, DEX:-2, INT:-2, WIL:-2, CHA:-2},
  // skills
  skills: [],
  // talents
  talents: [],           // array of talent ids (max 2)
  spellSchool: 'Arcane', // for spell picker
  spell: null,           // chosen spell {name, school}
  // equipment
  gold: 0,
  cart: [],              // [{name, cost, slots, weapon, shield, armor}]
  eqCat: Object.keys(EQUIPMENT)[0],
  // dice chains
  chains: {},            // {chainName: level 0-4}
  talentFilter: 'All',
};

function ageCfg(){ return state.age ? AGE[state.age] : null; }
function pointsLeft(){
  const cfg = ageCfg(); if(!cfg) return 0;
  const spent = Object.values(state.abilities).reduce((a,v)=>a+(v-(-2)),0);
  return cfg.points - spent;
}
function linksLeft(){
  const cfg = ageCfg(); if(!cfg) return 0;
  const used = Object.values(state.chains).reduce((a,v)=>a+v,0);
  return cfg.links - used;
}
function totalSpent(){ return state.cart.reduce((a,i)=>a+i.cost,0); }
function goldLeft(){ return state.gold - totalSpent(); }

function hp(){ return 10 + state.abilities.STR + state.abilities.WIL + (state.talents.includes('tough') ? 5 : 0); }
function supply(){ return (state.talents.includes('resourceful') ? 10 : 5) + state.abilities.INT; }
function itemSlots(){ return 15 + state.abilities.STR; }
function ac(){
  const armor = state.cart.find(i=>i.armor);
  const shield = state.cart.find(i=>i.shield);
  let base = 0;
  if(armor){
    if(armor.name==='Light Armor') base=2;
    else if(armor.name==='Medium Armor') base=4;
    else if(armor.name==='Heavy Armor') base=6;
  } else if(state.talents.includes('iron_skin')){
    base=2;
  }
  let shieldBonus = 0;
  if(shield) shieldBonus = 1;
  return base + shieldBonus + ' + INT';
}

function hasSpellcasting(){ return state.talents.includes('spellcast'); }
function hasCantrips(){ return state.talents.includes('cantrips'); }

// Which chains should exist for this character?
function getChainSources(){
  const sources = [];
  // weapons in cart
  state.cart.forEach(i=>{
    if(i.weapon) sources.push({key:i.name, label:i.name});
    if(i.shield) sources.push({key:i.name+'-shield', label:i.name+' (Shield)'});
  });
  // spell
  if(state.spell) sources.push({key:'spell-'+state.spell.name, label:state.spell.name+' (Spell)'});
  // talent chains
  state.talents.forEach(tid=>{
    const t = TALENTS.find(x=>x.id===tid);
    if(t && t.chain) sources.push({key:tid, label:t.chainName});
  });
  return sources;
}

function syncChains(){
  const sources = getChainSources();
  const newChains = {};
  sources.forEach(s=>{
    newChains[s.key] = state.chains[s.key] || 0;
  });
  state.chains = newChains;
}

// ═══════════════════════════════════════════════════════════
// RENDER ENGINE
// ═══════════════════════════════════════════════════════════

function render(){
  renderNav();
  renderStepContent();
  renderNavButtons();
}

function renderNav(){
  const nav = document.getElementById('stepsNav');
  nav.innerHTML = '';
  STEP_NAMES.forEach((name,i)=>{
    if(i>0){
      const line = document.createElement('div');
      line.className = 'step-line'+(i<=state.step?' done':'');
      nav.appendChild(line);
    }
    const node = document.createElement('div');
    const isDone = i < state.step;
    const isActive = i === state.step;
    node.className = 'step-node'+(isDone?' done':'')+(isActive?' active':'')+(isDone?' clickable':'');
    if(isDone) node.onclick = ()=>{ state.step=i; render(); };
    node.innerHTML = `
      <div class="step-circle">${isDone?'✓':i+1}</div>
      <div class="step-lbl">${name}</div>`;
    nav.appendChild(node);
  });
}

function renderNavButtons(){
  const back = document.getElementById('btnBack');
  const next = document.getElementById('btnNext');
  back.style.visibility = state.step===0?'hidden':'visible';
  if(state.step===STEP_COUNT-1){
    next.style.display='none';
  } else {
    next.style.display='inline-flex';
    next.textContent = state.step===STEP_COUNT-2 ? 'View Character →' : 'Continue →';
    next.disabled = !canProceed();
  }
}

function canProceed(){
  const s = state.step;
  if(s===0) return state.name.trim()&&state.descriptor.trim()&&state.conviction.trim();
  if(s===1) return !!state.age;
  if(s===2) return pointsLeft()===0;
  if(s===3) return ageCfg() && state.skills.length===ageCfg().skills;
  if(s===4){
    if(state.talents.length<2) return false;
    if(hasSpellcasting()&&!state.spell) return false;
    return true;
  }
  if(s===5) return state.gold>0;
  if(s===6) return true;
  return true;
}

function renderStepContent(){
  const wrap = document.getElementById('steps-wrap');
  const renders = [
    renderConcept, renderAge, renderAbilities, renderSkills,
    renderTalents, renderEquipment, renderChains, renderSheet
  ];
  wrap.innerHTML = '';
  wrap.appendChild(renders[state.step]());
}

// ─── STEP 0: CONCEPT ──────────────────────────────────────

function renderConcept(){
  const d = div('card');
  d.innerHTML = `
    <div class="card-title">Hero Concept</div>
    <div class="card-sub">Who is this person, and what drives them into danger?</div>
    <div class="field"><label class="lbl">Name of Hero</label>
      <input type="text" id="f-name" value="${esc(state.name)}" placeholder="e.g. Inga Vētra"/></div>
    <div class="field"><label class="lbl">Descriptor</label>
      <input type="text" id="f-desc" value="${esc(state.descriptor)}" placeholder="e.g. Disgraced Knight, Wandering Herbalist…"/>
      <div class="hint">A two-to-three word phrase capturing who your hero is.</div></div>
    <div class="field"><label class="lbl">Roots <span style="color:var(--muted);font-size:.8em;letter-spacing:0">(optional)</span></label>
      <textarea id="f-roots" placeholder="A sentence or two grounding your hero in the world. Where do they come from?">${esc(state.roots)}</textarea></div>
    <div class="field"><label class="lbl">Conviction</label>
      <input type="text" id="f-conv" value="${esc(state.conviction)}" placeholder="Something your hero strongly believes. e.g. "Debts of blood must be repaid.""/>
      <div class="hint">Your Conviction drives every decision and earns XP at session end.</div></div>`;
  d.querySelector('#f-name').oninput = e=>{ state.name=e.target.value; renderNavButtons(); };
  d.querySelector('#f-desc').oninput = e=>{ state.descriptor=e.target.value; renderNavButtons(); };
  d.querySelector('#f-roots').oninput = e=>{ state.roots=e.target.value; };
  d.querySelector('#f-conv').oninput = e=>{ state.conviction=e.target.value; renderNavButtons(); };
  return d;
}

// ─── STEP 1: AGE ──────────────────────────────────────────

function renderAge(){
  const d = div('card');
  d.innerHTML = `
    <div class="card-title">Age</div>
    <div class="card-sub">Your age determines raw potential and experience. Choose wisely.</div>
    <div class="age-grid">
      ${Object.entries(AGE).map(([age,cfg])=>`
        <div class="age-card ${state.age===age?'sel':''}" data-age="${age}">
          <div class="age-name">${age}</div>
          <div class="age-stat">Ability Points <strong>${cfg.points}</strong></div>
          <div class="age-stat">Skills <strong>${cfg.skills}</strong></div>
          <div class="age-stat">Chain Links <strong>${cfg.links}</strong></div>
        </div>`).join('')}
    </div>`;
  d.querySelectorAll('.age-card').forEach(card=>{
    card.onclick = ()=>{ state.age=card.dataset.age; state.skills=[]; render(); };
  });
  return d;
}

// ─── STEP 2: ABILITIES ────────────────────────────────────

function renderAbilities(){
  const d = div('card');
  const pl = pointsLeft();
  const h = hp(), s = supply(), sl = itemSlots();
  d.innerHTML = `
    <div class="card-title">Ability Scores</div>
    <div class="card-sub">All abilities start at –2. Distribute ${ageCfg().points} points. Maximum score: +5.</div>
    <div class="pts-bar">
      <span class="pts-lbl">Points Remaining</span>
      <span class="pts-cnt ${pl===0?'':''}"> ${pl}</span>
    </div>
    <div class="ability-grid">
      ${ABILITY_META.map(ab=>`
        <div class="ab-box">
          <div class="ab-abbr">${ab.id}</div>
          <div class="ab-full">${ab.desc}</div>
          <div class="ab-ctrl">
            <button class="ab-btn" data-ab="${ab.id}" data-d="-1">−</button>
            <div class="ab-val ${state.abilities[ab.id]>0?'pos':state.abilities[ab.id]<0?'neg':''}" id="abv-${ab.id}">${fmt(state.abilities[ab.id])}</div>
            <button class="ab-btn" data-ab="${ab.id}" data-d="1">+</button>
          </div>
        </div>`).join('')}
    </div>
    <hr class="sep"/>
    <div class="derived-row">
      <div class="derived-box"><div class="derived-lbl">Hit Points</div><div class="derived-val">${h}</div><div class="derived-form">10 + STR + WIL</div></div>
      <div class="derived-box"><div class="derived-lbl">Supply</div><div class="derived-val">${s}</div><div class="derived-form">5 + INT</div></div>
      <div class="derived-box"><div class="derived-lbl">Item Slots</div><div class="derived-val">${sl}</div><div class="derived-form">15 + STR</div></div>
    </div>`;
  d.querySelectorAll('.ab-btn').forEach(btn=>{
    btn.onclick = ()=>{
      const ab = btn.dataset.ab, delta = parseInt(btn.dataset.d);
      const cur = state.abilities[ab], next = cur+delta;
      if(next<-2||next>5) return;
      if(delta>0&&pointsLeft()<=0) return;
      state.abilities[ab]=next;
      render();
    };
  });
  return d;
}

// ─── STEP 3: SKILLS ───────────────────────────────────────

function renderSkills(){
  const cfg = ageCfg();
  const d = div('card');
  d.innerHTML = `
    <div class="card-title">Skills</div>
    <div class="card-sub">When a Skill applies to a Check, add your Ability Score twice instead of once.</div>
    <div class="tally">Selected: <span>${state.skills.length}</span> / ${cfg.skills}</div>
    <div class="skill-grid">
      ${SKILLS.map(sk=>{
        const sel = state.skills.includes(sk);
        const locked = !sel && state.skills.length>=cfg.skills;
        return `<div class="skill-chip ${sel?'sel':''} ${locked?'locked':''}" data-sk="${sk}">${sk}</div>`;
      }).join('')}
    </div>`;
  d.querySelectorAll('.skill-chip').forEach(chip=>{
    chip.onclick = ()=>{
      const sk = chip.dataset.sk;
      const has = state.skills.includes(sk);
      if(!has && state.skills.length>=cfg.skills) return;
      state.skills = has ? state.skills.filter(s=>s!==sk) : [...state.skills, sk];
      render();
    };
  });
  return d;
}

// ─── STEP 4: TALENTS ──────────────────────────────────────

function renderTalents(){
  const frag = document.createDocumentFragment();

  // Main talent picker
  const d = div('card');
  const cats = ['All','Offensive','Defensive','Utility','Mystique'];
  const filtered = state.talentFilter==='All' ? TALENTS : TALENTS.filter(t=>t.cat===state.talentFilter);
  d.innerHTML = `
    <div class="card-title">Talents</div>
    <div class="card-sub">Choose exactly 2 Talents. They define how your hero fights, survives, and surprises.</div>
    <div class="tally">Selected: <span>${state.talents.length}</span> / 2</div>
    <div class="filter-row">
      ${cats.map(c=>{
        const key = c==='All'?'all':c.toLowerCase().slice(0,3);
        return `<button class="f-btn ${state.talentFilter===c?'a '+key:''}" data-cat="${c}">${c}</button>`;
      }).join('')}
    </div>
    <div class="talent-grid">
      ${filtered.map(t=>{
        const sel = state.talents.includes(t.id);
        const locked = state.talents.length>=2&&!sel;
        const col = TALENT_CATS[t.cat];
        return `<div class="t-card ${sel?'sel':''} ${locked?'locked':''}" data-tid="${t.id}">
          <span class="t-tag" style="color:${col};border-color:${col}">${t.cat}</span>
          <div class="t-name"><span class="talent-cat-dot" style="background:${col}"></span>${t.name}</div>
          <div class="t-desc">${t.desc}</div>
        </div>`;
      }).join('')}
    </div>`;
  d.querySelectorAll('.f-btn').forEach(btn=>{
    btn.onclick=()=>{ state.talentFilter=btn.dataset.cat; render(); };
  });
  d.querySelectorAll('.t-card').forEach(card=>{
    card.onclick=()=>{
      const tid = card.dataset.tid;
      const has = state.talents.includes(tid);
      if(!has&&state.talents.length>=2) return;
      if(has){ state.talents=state.talents.filter(x=>x!==tid); }
      else { state.talents=[...state.talents, tid]; }
      // clear spell if spellcasting deselected
      if(!state.talents.includes('spellcast')) state.spell=null;
      render();
    };
  });
  frag.appendChild(d);

  // Spell picker (if spellcasting selected)
  if(hasSpellcasting()){
    const sd = div('card');
    const school = state.spellSchool;
    const ability = SPELL_ABILITY[school];
    const score = state.abilities[ability];
    const spells = SPELLS[school];
    const cantrips = hasCantrips();
    sd.innerHTML = `
      <div class="card-title">Starting Spell</div>
      <div class="card-sub">${cantrips?'This spell will be memorized via Cantrips — it won\'t occupy an Inventory Slot.':'This spell will occupy one Inventory Slot.'}</div>
      <div class="school-tabs">
        ${Object.keys(SPELLS).map(sc=>`<button class="s-tab ${school===sc?'a':''}" data-sc="${sc}">${sc} (${SPELL_ABILITY[sc]})</button>`).join('')}
      </div>
      ${score<0?`<div class="spell-warn">⚠ Your ${ability} is ${fmt(score)} — ${school} spells may be difficult to cast effectively.</div>`:''}
      <div class="spell-grid">
        ${spells.map(sp=>{
          const sel = state.spell&&state.spell.name===sp.name&&state.spell.school===school;
          return `<div class="sp-item ${sel?'sel':''}" data-sp='${JSON.stringify({name:sp.name,school})}'>
            <div class="sp-tier">${sp.tier}</div>
            <div class="sp-name">${sp.name}</div>
            <div class="sp-desc">${sp.desc}</div>
          </div>`;
        }).join('')}
      </div>`;
    sd.querySelectorAll('.s-tab').forEach(tab=>{
      tab.onclick=()=>{ state.spellSchool=tab.dataset.sc; render(); };
    });
    sd.querySelectorAll('.sp-item').forEach(item=>{
      item.onclick=()=>{ state.spell=JSON.parse(item.dataset.sp); render(); };
    });
    frag.appendChild(sd);
  }

  return frag;
}

// ─── STEP 5: EQUIPMENT ────────────────────────────────────

function renderEquipment(){
  const d = div();
  const cats = Object.keys(EQUIPMENT);
  const items = EQUIPMENT[state.eqCat];
  const gl = goldLeft();

  d.innerHTML = `
    <div class="card">
      <div class="card-title">Equipment</div>
      <div class="card-sub">Roll or enter your starting gold, then outfit your hero.</div>
      <div class="gold-panel">
        <span style="font-size:1.4rem">⚙</span>
        <label class="pts-lbl" style="white-space:nowrap">Starting Gold</label>
        <input type="number" class="gold-inp" id="gold-inp" min="0" value="${state.gold||''}" placeholder="0"/>
        <button class="btn-roll" id="btn-roll">Roll 3d20</button>
        <span class="gold-remaining">Remaining: <span>${gl}</span> gp</span>
      </div>
      <div class="eq-cats">
        ${cats.map(c=>`<button class="ec-btn ${state.eqCat===c?'a':''}" data-cat="${c}">${c}</button>`).join('')}
      </div>
      <div class="eq-wrap">
        <table class="eq-tbl">
          <thead><tr><th>Item</th><th>Properties</th><th>Slots</th><th>Cost</th><th></th></tr></thead>
          <tbody>
            ${items.map(item=>{
              const cantAfford = gl < item.cost && !state.cart.find(i=>i.name===item.name);
              return `<tr>
                <td><div class="eq-n">${item.name}</div></td>
                <td><div class="eq-p">${item.props}</div></td>
                <td>${item.slots}</td>
                <td class="eq-c">${item.cost} gp</td>
                <td><button class="eq-add" data-item='${JSON.stringify(item)}' ${cantAfford?'disabled':''}>+ Add</button></td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
      ${state.cart.length>0?`
      <div class="cart">
        <div class="cart-ttl">Inventory</div>
        ${state.cart.map((item,i)=>`
          <div class="cart-item">
            <span class="ci-name">${item.name}</span>
            <span class="ci-cost">${item.cost} gp</span>
            <button class="ci-rm" data-idx="${i}">✕</button>
          </div>`).join('')}
        <div class="cart-sum">
          <span>Total Spent</span>
          <span>${totalSpent()} / ${state.gold} gp</span>
        </div>
      </div>`:''}
      ${state.gold>0&&state.cart.length===0?'<div class="info-box">Browse the categories above and add items to your inventory.</div>':''}
      ${state.gold===0?'<div class="warn-box">Enter your starting gold to begin shopping.</div>':''}
    </div>`;

  d.querySelector('#gold-inp').oninput = e=>{
    state.gold = parseInt(e.target.value)||0;
    // remove items that now exceed budget
    state.cart = state.cart.filter(i=>totalSpent()<=state.gold);
    render();
  };
  d.querySelector('#btn-roll').onclick = ()=>{
    state.gold = Math.floor(Math.random()*20+1)+Math.floor(Math.random()*20+1)+Math.floor(Math.random()*20+1);
    state.cart = state.cart.filter(i=>totalSpent()<=state.gold);
    render();
  };
  d.querySelectorAll('.ec-btn').forEach(btn=>{
    btn.onclick=()=>{ state.eqCat=btn.dataset.cat; render(); };
  });
  d.querySelectorAll('.eq-add').forEach(btn=>{
    btn.onclick=()=>{
      const item = JSON.parse(btn.dataset.item);
      if(goldLeft()<item.cost) return;
      state.cart.push(item);
      render();
    };
  });
  d.querySelectorAll('.ci-rm').forEach(btn=>{
    btn.onclick=()=>{ state.cart.splice(parseInt(btn.dataset.idx),1); render(); };
  });
  return d;
}

// ─── STEP 6: DICE CHAINS ──────────────────────────────────

function renderChains(){
  syncChains();
  const sources = getChainSources();
  const ll = linksLeft();
  const d = div('card');

  if(sources.length===0){
    d.innerHTML = `
      <div class="card-title">Dice Chains</div>
      <div class="card-sub">Bolster your chains using ${ageCfg().links} Chain Links.</div>
      <div class="no-chains">Your hero has no weapons, spells, or talent-based chains to bolster.<br>Go back to Equipment to add some gear, or check your Talents.</div>`;
    return d;
  }

  d.innerHTML = `
    <div class="card-title">Dice Chains</div>
    <div class="card-sub">All chains start at d4. Each Link advances one chain by one step. Bolster wisely.</div>
    <div class="links-bar">
      <span class="links-lbl">Links Remaining</span>
      <span class="links-cnt">${ll}</span>
    </div>
    ${sources.map(s=>{
      const level = state.chains[s.key]||0;
      return `<div class="chain-item">
        <div class="chain-name">${s.label}</div>
        <div class="die-row">
          ${DICE_STEPS.map((die,i)=>`<div class="die-pip ${i<level?'unl':''} ${i===level?'cur':''}">${die}</div>`).join('')}
        </div>
        <div class="chain-ctrl">
          <button class="ch-btn" data-key="${s.key}" data-d="-1">−</button>
          <button class="ch-btn" data-key="${s.key}" data-d="1">+</button>
        </div>
      </div>`;
    }).join('')}`;

  d.querySelectorAll('.ch-btn').forEach(btn=>{
    btn.onclick=()=>{
      const key=btn.dataset.key, delta=parseInt(btn.dataset.d);
      const cur=state.chains[key]||0, next=cur+delta;
      if(next<0||next>4) return;
      if(delta>0&&linksLeft()<=0) return;
      state.chains[key]=next;
      render();
    };
  });
  return d;
}

// ─── STEP 7: CHARACTER SHEET ──────────────────────────────

function renderSheet(){
  const frag = document.createDocumentFragment();

  // Export button row
  const exportRow = div();
  exportRow.style.cssText='display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center';
  exportRow.innerHTML = `
    <button class="btn btn-primary" id="btn-export">⬇ Export as PNG</button>
    <button class="btn btn-sec" id="btn-restart">Start Over</button>`;
  exportRow.querySelector('#btn-export').onclick = exportPNG;
  exportRow.querySelector('#btn-restart').onclick = ()=>{
    if(confirm('Start a new character? All progress will be lost.')) location.reload();
  };
  frag.appendChild(exportRow);

  // Build inventory list for sheet
  const inventoryItems = [];
  // If spellcasting but NOT cantrips, spell is a physical item
  if(state.spell && !hasCantrips()) inventoryItems.push(state.spell.name+' (Spell)');
  state.cart.forEach(i=>inventoryItems.push(i.name));
  const maxInv = Math.max(itemSlots(), inventoryItems.length, 15);
  const invRows = Array.from({length:Math.min(maxInv,20)},(_,i)=>inventoryItems[i]||'');

  // Talents text for sheet
  const talentTexts = state.talents.map(tid=>{
    const t = TALENTS.find(x=>x.id===tid);
    if(!t) return '';
    let extra = '';
    if(tid==='spellcast'&&state.spell){
      if(hasCantrips()) extra = ` [Memorized: ${state.spell.name}]`;
      else extra = ` [Starting Spell: ${state.spell.name}]`;
    }
    return `${t.name}${extra}`;
  });

  // Chain summary
  const chainTexts = Object.entries(state.chains).map(([k,v])=>{
    const src = getChainSources().find(s=>s.key===k);
    return src ? `${src.label}: ${DICE_STEPS[v]}` : '';
  }).filter(Boolean);

  const sheetEl = document.createElement('div');
  sheetEl.id = 'sheet';
  sheetEl.innerHTML = `
    <div class="sh-topbar">
      <span class="sh-game">Dzintaru Dziesmas</span>
      <span class="sh-ed">Character Sheet · v0.8</span>
    </div>
    <div class="sh-inner">

      <!-- Name / Player / Descriptor / Age / XP / REP -->
      <div class="sh-row">
        <div class="sh-f" style="flex:2"><div class="sh-fl">Name of Hero</div><div class="sh-fv">${esc(state.name)}</div></div>
        <div class="sh-f"><div class="sh-fl">Player</div><div class="sh-fv"></div></div>
      </div>
      <div class="sh-row">
        <div class="sh-f" style="flex:2"><div class="sh-fl">Descriptor</div><div class="sh-fv">${esc(state.descriptor)}</div></div>
        <div class="sh-f"><div class="sh-fl">Age</div><div class="sh-fv">${state.age||''}</div></div>
        <div class="sh-f"><div class="sh-fl">XP</div><div class="sh-fv"></div></div>
        <div class="sh-f"><div class="sh-fl">REP</div><div class="sh-fv"></div></div>
      </div>

      <!-- Ability Scores -->
      <div class="sh-abs">
        ${ABILITY_META.map(ab=>`
          <div class="sh-ab">
            <div class="sh-ab-n">${ab.id}</div>
            <div class="sh-ab-v">${fmt(state.abilities[ab.id])}</div>
            <div class="sh-ab-c">${['STR','DEX','INT','WIL','CHA'].indexOf(ab.id)===0?'EXHAUSTED':ab.id==='DEX'?'DAZED':ab.id==='INT'?'AGITATED':ab.id==='WIL'?'HOLLOW':'INSECURE'}</div>
          </div>`).join('')}
      </div>

      <!-- Vitals -->
      <div class="sh-vitals">
        <div class="sh-vit"><div class="sh-vit-n">Hit Points</div><div class="sh-vit-v">${hp()}</div><div class="sh-vit-f">10+STR+WIL</div></div>
        <div class="sh-vit"><div class="sh-vit-n">Armor Class</div><div class="sh-vit-v">—</div><div class="sh-vit-f">Armor + Shield</div></div>
        <div class="sh-vit"><div class="sh-vit-n">Supply</div><div class="sh-vit-v">${supply()}</div><div class="sh-vit-f">5+INT</div></div>
      </div>

      <!-- Hero Dice + Conditions -->
      <div class="sh-cols">
        <div class="sh-sec">
          <div class="sh-sec-t">Hero Dice</div>
          <div class="sh-dice">
            ${['d4','d6','d8','d10','d12'].map(d=>`<div class="sh-die">${d}</div>`).join('')}
          </div>
        </div>
        <div class="sh-sec">
          <div class="sh-sec-t">Conditions</div>
          <div class="sh-conds">
            ${['Hindered','Inspired','Lost Spirit','Vulnerable'].map(c=>`
              <div class="sh-cond"><div class="cond-c"></div>${c}</div>`).join('')}
          </div>
        </div>
      </div>

      <!-- Dice Chains + Skills -->
      <div class="sh-cols">
        <div class="sh-sec">
          <div class="sh-sec-t">Dice Chains</div>
          <div class="sh-sec-b">
            ${chainTexts.length>0
              ? chainTexts.map(t=>`<div class="sh-line">${t}</div>`).join('')
              : '<div class="sh-line" style="color:#8a6030;font-style:italic">No chains bolstered</div>'}
            ${Array.from({length:Math.max(0,5-chainTexts.length)},()=>'<div class="sh-line"></div>').join('')}
          </div>
        </div>
        <div class="sh-sec">
          <div class="sh-sec-t">Skills</div>
          <div class="sh-sec-b">
            ${state.skills.map(s=>`<div class="sh-line">${s}</div>`).join('')}
            ${Array.from({length:Math.max(0,5-state.skills.length)},()=>'<div class="sh-line"></div>').join('')}
          </div>
        </div>
      </div>

      <!-- Conviction -->
      <div class="sh-conv">
        <div class="sh-fl" style="background:#1a0f02;color:#e8b84b;font-family:'Cinzel',serif;font-size:.6rem;letter-spacing:.17em;padding:4px 10px">Conviction</div>
        <div class="sh-conv-b">${state.conviction ? '"'+esc(state.conviction)+'"' : ''}</div>
      </div>

      <!-- Pockets + Talents -->
      <div class="sh-cols">
        <div class="sh-sec">
          <div class="sh-sec-t">Pockets <span style="font-family:'Crimson Pro',serif;font-style:italic;font-size:.75em;letter-spacing:0;text-transform:none;font-weight:400"> — really small items</span></div>
          <div class="sh-sec-b">
            <div class="sh-line"></div>
            <div class="sh-line"></div>
          </div>
        </div>
        <div class="sh-sec">
          <div class="sh-sec-t">Talents & Other Notes</div>
          <div class="sh-sec-b">
            ${talentTexts.map(t=>`<div class="sh-line">${t}</div>`).join('')}
            ${Array.from({length:Math.max(0,4-talentTexts.length)},()=>'<div class="sh-line"></div>').join('')}
          </div>
        </div>
      </div>

      <!-- Inventory -->
      <div class="sh-sec" style="margin-bottom:9px">
        <div class="sh-sec-t">Inventory <span style="font-family:'Crimson Pro',serif;font-style:italic;font-size:.75em;letter-spacing:0;text-transform:none;font-weight:400"> — Max Item Slots: ${itemSlots()}</span></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0;border-top:1px solid #c4a060">
          ${invRows.map((item,i)=>`
            <div class="sh-inv-r">
              <div class="sh-inv-n">${i+1}</div>
              <div class="sh-inv-i">${item}</div>
            </div>`).join('')}
        </div>
      </div>

      <!-- End of Session Questions -->
      <div class="sh-eos">
        <div class="sh-sec-t">End of Session Questions</div>
        ${EOS_QUESTIONS.map(q=>`
          <div class="sh-eos-q"><div class="eos-dot"></div>${q}</div>`).join('')}
      </div>

    </div><!-- sh-inner -->
  `;

  frag.appendChild(sheetEl);

  // Roots note
  if(state.roots){
    const note = div('card');
    note.innerHTML = `<div class="card-title" style="font-size:.9rem">Roots</div>
      <div style="font-style:italic;color:var(--muted2);margin-top:6px;font-size:.95rem">${esc(state.roots)}</div>`;
    frag.appendChild(note);
  }

  return frag;
}

// ═══════════════════════════════════════════════════════════
// PNG EXPORT
// ═══════════════════════════════════════════════════════════

function exportPNG(){
  const sheet = document.getElementById('sheet');
  if(!sheet){ alert('Sheet not found!'); return; }
  const btn = document.getElementById('btn-export');
  btn.textContent = 'Generating…';
  btn.disabled = true;
  html2canvas(sheet, {
    scale: 2,
    useCORS: true,
    backgroundColor: '#f0e6cc',
    logging: false
  }).then(canvas=>{
    const link = document.createElement('a');
    link.download = (state.name||'hero').replace(/\s+/g,'_')+'_character_sheet.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
    btn.textContent = '⬇ Export as PNG';
    btn.disabled = false;
  }).catch(err=>{
    console.error(err);
    btn.textContent = '⬇ Export as PNG';
    btn.disabled = false;
    alert('Export failed. Please try again.');
  });
}

// ═══════════════════════════════════════════════════════════
// NAV EVENTS
// ═══════════════════════════════════════════════════════════

document.getElementById('btnBack').onclick = ()=>{
  if(state.step>0){ state.step--; render(); window.scrollTo(0,0); }
};
document.getElementById('btnNext').onclick = ()=>{
  if(!canProceed()) return;
  if(state.step<STEP_COUNT-1){
    if(state.step===5) syncChains(); // prep chains before chain step
    state.step++;
    render();
    window.scrollTo(0,0);
  }
};

// ═══════════════════════════════════════════════════════════
// HELPERS
// ═══════════════════════════════════════════════════════════

function div(cls){
  const el = document.createElement('div');
  if(cls) el.className=cls;
  return el;
}
function fmt(n){ return n>=0?'+'+n:''+n; }
function esc(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// ═══════════════════════════════════════════════════════════
// BOOT
// ═══════════════════════════════════════════════════════════

render();
</script>
</body>
</html>
